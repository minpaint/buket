{% extends "shop/dashboard/base_dashboard.html" %}
{% block title %}Товары{% endblock %}
{% block topbar_title %}Товары{% endblock %}

{% block extra_styles %}
<style>
  .page-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:12px;flex-wrap:wrap}
  .search-box{display:flex;gap:8px;align-items:center;flex:1;max-width:340px}
  .search-box input{flex:1;padding:8px 12px;border:1px solid var(--Border);border-radius:8px;font-size:14px;outline:none}
  .search-box input:focus{border-color:var(--PrimaryDark)}
  .product-img{width:46px;height:46px;object-fit:cover;border-radius:6px;background:#f3f9f1;flex-shrink:0}
  .product-name-cell{display:flex;align-items:center;gap:10px}
  .price-input{
    width:100px;padding:5px 8px;
    border:1px solid var(--Border);border-radius:6px;
    font-size:14px;font-weight:700;color:var(--PrimaryDark);
    outline:none;transition:border-color .15s;
  }
  .price-input:focus{border-color:var(--PrimaryDark)}
  .price-input.changed{border-color:var(--Accent);background:#fff7ed}
  .published-toggle{cursor:pointer;display:inline-flex;align-items:center;gap:4px;font-size:13px}
  .toggle-dot{
    width:36px;height:20px;border-radius:999px;background:#d1d5db;
    position:relative;transition:background .2s;flex-shrink:0;
  }
  .toggle-dot::after{
    content:'';position:absolute;left:2px;top:2px;
    width:16px;height:16px;border-radius:50%;background:#fff;
    transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);
  }
  .toggle-dot.on{background:var(--PrimaryDark)}
  .toggle-dot.on::after{left:18px}
  .pagination{display:flex;gap:6px;align-items:center;margin-top:18px;flex-wrap:wrap}
  .page-btn{
    padding:5px 11px;border:1px solid var(--Border);border-radius:6px;
    font-size:13px;font-weight:600;cursor:pointer;background:#fff;color:#374151;
    transition:background .15s;
  }
  .page-btn:hover{background:var(--SoftBg)}
  .page-btn.active{background:var(--PrimaryDark);color:#fff;border-color:var(--PrimaryDark)}
  .page-btn:disabled{opacity:.4;cursor:default}
  @media(max-width:700px){
    .page-top{flex-direction:column;align-items:stretch}
    .search-box{max-width:100%}
    .col-hide{display:none}
    .price-input{width:80px}
  }
</style>
{% endblock %}

{% block content %}
<div class="page-top">
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Поиск по названию или артикулу…" oninput="filterProducts()">
  </div>
  <div style="display:flex;gap:8px">
    <a href="/dashboard/products/add/" class="btn btn-primary">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Добавить товар
    </a>
  </div>
</div>

<div class="card" style="padding:0">
  <div class="table-wrap" style="border:none;border-radius:12px">
    <table id="productsTable">
      <thead>
        <tr>
          <th style="width:56px"></th>
          <th>Название</th>
          <th class="col-hide">Артикул</th>
          <th>Цена, BYN</th>
          <th class="col-hide">Категория</th>
          <th>Витрина</th>
          <th>Опубликован</th>
          <th style="width:90px"></th>
        </tr>
      </thead>
      <tbody id="productsBody">
        {% for p in products %}
        <tr data-id="{{ p.id }}" data-search="{{ p.title|lower }} {{ p.article|lower }}">
          <td><img class="product-img" src="{{ p.image_url }}" alt="{{ p.title }}"></td>
          <td>
            <div style="font-weight:600;font-size:14px">{{ p.title }}</div>
          </td>
          <td class="col-hide"><span style="color:var(--Muted);font-size:13px">{{ p.article|default:"—" }}</span></td>
          <td>
            <input class="price-input" type="number" step="0.01" min="0"
              value="{{ p.price|floatformat:2 }}"
              data-original="{{ p.price|floatformat:2 }}"
              data-id="{{ p.id }}"
              onchange="markPriceChanged(this)"
              onkeydown="if(event.key==='Enter')savePrice(this)">
          </td>
          <td class="col-hide"><span style="font-size:13px">{{ p.category_name|default:"—" }}</span></td>
          <td>
            <button class="published-toggle" onclick="toggleShowcase({{ p.id }}, this)" title="Включить/выключить витрину">
              <span class="toggle-dot {% if p.is_online_showcase %}on{% endif %}"></span>
            </button>
          </td>
          <td>
            <button class="published-toggle" onclick="togglePublished({{ p.id }}, this)" title="Опубликован/Скрыт">
              <span class="toggle-dot {% if p.is_published %}on{% endif %}"></span>
            </button>
          </td>
          <td>
            <div style="display:flex;gap:6px">
              <a href="/dashboard/products/{{ p.id }}/" class="btn btn-secondary btn-sm btn-icon" title="Редактировать">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              </a>
              <button class="btn btn-danger btn-sm btn-icon" onclick="deleteProduct({{ p.id }})" title="Удалить">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>
              </button>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="8" style="text-align:center;color:var(--Muted);padding:32px">Товаров пока нет</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  function filterProducts() {
    var q = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('#productsBody tr[data-id]').forEach(function(row) {
      row.style.display = row.dataset.search.includes(q) ? '' : 'none';
    });
  }

  function markPriceChanged(input) {
    var orig = parseFloat(input.dataset.original);
    var cur = parseFloat(input.value);
    input.classList.toggle('changed', Math.abs(cur - orig) > 0.001);
  }

  function savePrice(input) {
    var id = input.dataset.id;
    var price = parseFloat(input.value);
    if (isNaN(price) || price < 0) return;
    fetch('/dashboard/api/product/' + id + '/price/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken()},
      body: JSON.stringify({price: price})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.ok) {
        input.dataset.original = price.toFixed(2);
        input.classList.remove('changed');
        showAlert('Цена обновлена', 'success');
      } else {
        showAlert(data.error || 'Ошибка', 'error');
      }
    });
  }

  // Сохранить все изменённые цены
  function saveAllPrices() {
    document.querySelectorAll('.price-input.changed').forEach(function(inp) { savePrice(inp); });
  }

  function toggleShowcase(id, btn) {
    var dot = btn.querySelector('.toggle-dot');
    var newVal = !dot.classList.contains('on');
    fetch('/dashboard/api/product/' + id + '/showcase/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken()},
      body: JSON.stringify({value: newVal})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.ok) dot.classList.toggle('on', newVal);
    });
  }

  function togglePublished(id, btn) {
    var dot = btn.querySelector('.toggle-dot');
    var newVal = !dot.classList.contains('on');
    fetch('/dashboard/api/product/' + id + '/published/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken()},
      body: JSON.stringify({value: newVal})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.ok) dot.classList.toggle('on', newVal);
    });
  }

  function deleteProduct(id) {
    if (!confirm('Удалить товар? Это действие нельзя отменить.')) return;
    fetch('/dashboard/api/product/' + id + '/delete/', {
      method: 'POST',
      headers: {'X-CSRFToken': csrfToken()}
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.ok) {
        var row = document.querySelector('tr[data-id="' + id + '"]');
        if (row) row.remove();
        showAlert('Товар удалён', 'success');
      } else {
        showAlert(data.error || 'Ошибка', 'error');
      }
    });
  }
</script>
{% endblock %}
