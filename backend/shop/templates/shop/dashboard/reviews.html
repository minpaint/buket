{% extends "shop/dashboard/base_dashboard.html" %}
{% block title %}Отзывы{% endblock %}
{% block topbar_title %}Отзывы{% endblock %}

{% block extra_styles %}
<style>
  .page-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:12px;flex-wrap:wrap}
  .search-box{display:flex;gap:8px;align-items:center;flex:1;max-width:340px}
  .search-box input{flex:1;padding:8px 12px;border:1px solid var(--Border);border-radius:8px;font-size:14px;outline:none}
  .search-box input:focus{border-color:var(--PrimaryDark)}
  .rating-stars{color:#f59e0b;letter-spacing:1px;font-size:13px;white-space:nowrap}
  .published-toggle{cursor:pointer;display:inline-flex;align-items:center;gap:4px;background:none;border:none;padding:0}
  .toggle-dot{
    width:36px;height:20px;border-radius:999px;background:#d1d5db;
    position:relative;transition:background .2s;flex-shrink:0;
  }
  .toggle-dot::after{
    content:'';position:absolute;left:2px;top:2px;
    width:16px;height:16px;border-radius:50%;background:#fff;
    transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);
  }
  .toggle-dot.on{background:var(--PrimaryDark)}
  .toggle-dot.on::after{left:18px}
  .text-preview{font-size:13px;color:#374151;max-width:340px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .badge-pending{display:inline-block;background:#fef3c7;color:#92400e;border-radius:4px;font-size:11px;font-weight:700;padding:2px 7px;letter-spacing:.03em}
  .badge-published{display:inline-block;background:#d1fae5;color:#065f46;border-radius:4px;font-size:11px;font-weight:700;padding:2px 7px;letter-spacing:.03em}
  @media(max-width:700px){
    .page-top{flex-direction:column;align-items:stretch}
    .search-box{max-width:100%}
    .col-hide{display:none}
  }
</style>
{% endblock %}

{% block content %}
<div class="page-top">
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Поиск по автору или тексту…" oninput="filterReviews()">
  </div>
  <div style="color:var(--Muted);font-size:13px">
    Всего: <strong>{{ reviews|length }}</strong>
  </div>
</div>

<div class="card" style="padding:0">
  <div class="table-wrap" style="border:none;border-radius:12px">
    <table id="reviewsTable">
      <thead>
        <tr>
          <th>Магазин</th>
          <th>Автор</th>
          <th class="col-hide">Оценка</th>
          <th>Текст</th>
          <th class="col-hide">Дата</th>
          <th>Опубликован</th>
          <th style="width:56px"></th>
        </tr>
      </thead>
      <tbody id="reviewsBody">
        {% for r in reviews %}
        <tr data-id="{{ r.id }}" data-search="{{ r.author|lower }} {{ r.company|lower }} {{ r.text|lower }}">
          <td>
            <span style="font-size:13px;color:var(--PrimaryDark);font-weight:600">{{ r.store_name }}</span>
          </td>
          <td>
            <div style="font-weight:600;font-size:14px;color:var(--PrimaryDark)">{{ r.author }}</div>
            {% if r.company %}<div style="font-size:12px;color:var(--Muted)">{{ r.company }}</div>{% endif %}
          </td>
          <td class="col-hide">
            <span class="rating-stars">
              {% if r.rating == 5 %}★★★★★{% elif r.rating == 4 %}★★★★☆{% elif r.rating == 3 %}★★★☆☆{% elif r.rating == 2 %}★★☆☆☆{% else %}★☆☆☆☆{% endif %}
            </span>
          </td>
          <td>
            <span class="text-preview" title="{{ r.text }}">{{ r.text }}</span>
          </td>
          <td class="col-hide">
            <span style="font-size:12px;color:var(--Muted)">{{ r.created_at }}</span>
          </td>
          <td>
            <button class="published-toggle" onclick="togglePublished({{ r.id }}, this)" title="Опубликовать / скрыть">
              <span class="toggle-dot {% if r.is_published %}on{% endif %}"></span>
            </button>
            <span class="{% if r.is_published %}badge-published{% else %}badge-pending{% endif %}" style="margin-left:6px">
              {% if r.is_published %}Виден{% else %}На модерации{% endif %}
            </span>
          </td>
          <td>
            <button class="btn btn-danger btn-sm btn-icon" onclick="deleteReview({{ r.id }})" title="Удалить">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" style="text-align:center;color:var(--Muted);padding:40px">
            {% if request.user.is_superuser or request.user.is_staff %}
              Отзывов пока нет
            {% else %}
              Отзывов для ваших магазинов пока нет
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  function filterReviews() {
    var q = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('#reviewsBody tr[data-id]').forEach(function(row) {
      row.style.display = row.dataset.search.includes(q) ? '' : 'none';
    });
  }

  function togglePublished(id, btn) {
    var dot = btn.querySelector('.toggle-dot');
    var badge = btn.nextElementSibling;
    var newVal = !dot.classList.contains('on');
    fetch('/dashboard/api/review/' + id + '/published/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken()},
      body: JSON.stringify({value: newVal})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.ok) {
        dot.classList.toggle('on', newVal);
        if (badge) {
          badge.textContent = newVal ? 'Виден' : 'На модерации';
          badge.className = newVal ? 'badge-published' : 'badge-pending';
          badge.style.marginLeft = '6px';
        }
        showAlert(newVal ? 'Отзыв опубликован' : 'Отзыв скрыт', 'success');
      } else {
        showAlert(data.error || 'Ошибка', 'error');
      }
    });
  }

  function deleteReview(id) {
    if (!confirm('Удалить отзыв? Это действие нельзя отменить.')) return;
    fetch('/dashboard/api/review/' + id + '/delete/', {
      method: 'POST',
      headers: {'X-CSRFToken': csrfToken()}
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.ok) {
        var row = document.querySelector('tr[data-id="' + id + '"]');
        if (row) row.remove();
        showAlert('Отзыв удалён', 'success');
      } else {
        showAlert(data.error || 'Ошибка', 'error');
      }
    });
  }
</script>
{% endblock %}
